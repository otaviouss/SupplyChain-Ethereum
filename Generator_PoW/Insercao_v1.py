# Aplicação Python para utilização do contrato Insercao_v1

from web3 import Web3, IPCProvider
import json

web3 = Web3(Web3.HTTPProvider("http://127.0.0.1:8545"))

web3.eth.defaultAccount = web3.eth.accounts[0]

#Contrato Incialização

abi = json.loads('[{"inputs":[],"stateMutability":"payable","type":"constructor"},{"inputs":[{"internalType":"address","name":"usuario","type":"address"},{"internalType":"string","name":"label","type":"string"}],"name":"addUsuario","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"quantidadeUsuarios","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"usuario","type":"address"}],"name":"verificarUsuario","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}]')

bytecode = '60806040526000600255336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160405180604001604052806000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020016040518060400160405280600581526020017f41646d696e000000000000000000000000000000000000000000000000000000815250815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550602082015181600101908051906020019061015892919061016c565b505050600160025401600281905550610211565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101ad57805160ff19168380011785556101db565b828001600101855582156101db579182015b828111156101da5782518255916020019190600101906101bf565b5b5090506101e891906101ec565b5090565b61020e91905b8082111561020a5760008160009055506001016101f2565b5090565b90565b6104ce806102206000396000f3fe608060405234801561001057600080fd5b50600436106100415760003560e01c80630e232a20146100465780637706558214610121578063b6f44bcd1461013f575b600080fd5b61011f6004803603604081101561005c57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019064010000000081111561009957600080fd5b8201836020820111156100ab57600080fd5b803590602001918460018302840111640100000000831117156100cd57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061019b565b005b61012961030c565b6040518082815260200191505060405180910390f35b6101816004803603602081101561015557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050610316565b604051808215151515815260200191505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610240576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260338152602001806104666033913960400191505060405180910390fd5b600160405180604001604052808473ffffffffffffffffffffffffffffffffffffffff16815260200183815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010190805190602001906102f99291906103c0565b5050506001600254016002819055505050565b6000600254905090565b60008060009050600090505b6002548110156103b5578273ffffffffffffffffffffffffffffffffffffffff166001828154811061035057fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156103a85760019150506103bb565b8080600101915050610322565b60009150505b919050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061040157805160ff191683800117855561042f565b8280016001018555821561042f579182015b8281111561042e578251825591602001919060010190610413565b5b50905061043c9190610440565b5090565b61046291905b8082111561045e576000816000905550600101610446565b5090565b9056fe4170656e6173206f2061646d696e6973747261646f7220706f646520657865637574617220657373612066756ec3a7c3a36f2ea264697066735822122091da03fc4adfe4ba5760132443010553e4428e0e3728544da44ab7e8d961a91064736f6c63430006040033'

Fila = web3.eth.contract(abi=abi, bytecode=bytecode)

tx_hash = "0x3b722a5c7af9275951ca2d2101790311d7e3dc8158b68587c69c56fcd86dd0b6"

tx_receipt = web3.eth.getTransactionReceipt(tx_hash)

contratoInicializacao= web3.eth.contract(
    address=tx_receipt.contractAddress,
    abi=abi
)

#Contrato Inserção

abi = json.loads('[{"inputs":[],"stateMutability":"payable","type":"constructor"},{"inputs":[{"internalType":"string","name":"hash","type":"string"},{"internalType":"string","name":"day","type":"string"},{"internalType":"string","name":"time","type":"string"},{"internalType":"string","name":"place","type":"string"},{"internalType":"string","name":"code","type":"string"},{"internalType":"string","name":"codeAnterior","type":"string"},{"internalType":"address","name":"addrSensor","type":"address"},{"internalType":"bool","name":"access","type":"bool"}],"name":"addInfo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"infos","outputs":[{"internalType":"string","name":"hashInfo","type":"string"},{"internalType":"string","name":"day","type":"string"},{"internalType":"string","name":"time","type":"string"},{"internalType":"string","name":"place","type":"string"},{"internalType":"string","name":"code","type":"string"},{"internalType":"string","name":"codeAnterior","type":"string"},{"internalType":"address","name":"addrSensor","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"quant","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"codeFinal","type":"string"},{"internalType":"uint256","name":"quantidade","type":"uint256"}],"name":"rastreioProd","outputs":[{"components":[{"internalType":"string","name":"hashInfo","type":"string"},{"internalType":"string","name":"day","type":"string"},{"internalType":"string","name":"time","type":"string"},{"internalType":"string","name":"place","type":"string"},{"internalType":"string","name":"code","type":"string"},{"internalType":"string","name":"codeAnterior","type":"string"},{"internalType":"address","name":"addrSensor","type":"address"}],"internalType":"struct Insercao.Dado[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"code","type":"string"}],"name":"verificarInfo","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}]')

bytecode = '6080604052600060015560006040518060e001604052806040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525081526020016040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525081526020016040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525081526020016040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525081526020016040518060400160405280600181526020017f300000000000000000000000000000000000000000000000000000000000000081525081526020016040518060400160405280600181526020017f30000000000000000000000000000000000000000000000000000000000000008152508152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090806001815401808255809150506001900390600052602060002090600702016000909190919091506000820151816000019080519060200190620001da929190620002c5565b506020820151816001019080519060200190620001f9929190620002c5565b50604082015181600201908051906020019062000218929190620002c5565b50606082015181600301908051906020019062000237929190620002c5565b50608082015181600401908051906020019062000256929190620002c5565b5060a082015181600501908051906020019062000275929190620002c5565b5060c08201518160060160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505062000374565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200030857805160ff191683800117855562000339565b8280016001018555821562000339579182015b82811115620003385782518255916020019190600101906200031b565b5b5090506200034891906200034c565b5090565b6200037191905b808211156200036d57600081600090555060010162000353565b5090565b90565b6116d780620003846000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c806328de3c9b1461005c5780635d7e9490146100925780636218b1fa146100c2578063f0b40726146100de578063f5825fd11461010e575b600080fd5b610076600480360381019061007191906110da565b61012c565b6040516100899796959493929190611423565b60405180910390f35b6100ac60048036038101906100a79190610f03565b61052b565b6040516100b99190611408565b60405180910390f35b6100dc60048036038101906100d79190610f44565b6105d5565b005b6100f860048036038101906100f39190611086565b610759565b60405161010591906113e6565b60405180910390f35b610116610d60565b60405161012391906114bc565b60405180910390f35b6000818154811061013957fe5b9060005260206000209060070201600091509050806000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156101e55780601f106101ba576101008083540402835291602001916101e5565b820191906000526020600020905b8154815290600101906020018083116101c857829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102835780601f1061025857610100808354040283529160200191610283565b820191906000526020600020905b81548152906001019060200180831161026657829003601f168201915b505050505090806002018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103215780601f106102f657610100808354040283529160200191610321565b820191906000526020600020905b81548152906001019060200180831161030457829003601f168201915b505050505090806003018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103bf5780601f10610394576101008083540402835291602001916103bf565b820191906000526020600020905b8154815290600101906020018083116103a257829003601f168201915b505050505090806004018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561045d5780601f106104325761010080835404028352916020019161045d565b820191906000526020600020905b81548152906001019060200180831161044057829003601f168201915b505050505090806005018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104fb5780601f106104d0576101008083540402835291602001916104fb565b820191906000526020600020905b8154815290600101906020018083116104de57829003601f168201915b5050505050908060060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905087565b6000806000905060015490505b60008111156105ca578260405160200161055291906113b8565b604051602081830303815290604052805190602001206000828154811061057557fe5b906000526020600020906007020160040160405160200161059691906113cf565b6040516020818303038152906040528051906020012014156105bc5760019150506105d0565b808060019003915050610538565b60009150505b919050565b801561074f5760006040518060e001604052808a81526020018981526020018881526020018781526020018681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff168152509080600181540180825580915050600190039060005260206000209060070201600090919091909150600082015181600001908051906020019061066b929190610d78565b506020820151816001019080519060200190610688929190610d78565b5060408201518160020190805190602001906106a5929190610d78565b5060608201518160030190805190602001906106c2929190610d78565b5060808201518160040190805190602001906106df929190610d78565b5060a08201518160050190805190602001906106fc929190610d78565b5060c08201518160060160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505061074e610d66565b5b5050505050505050565b60606000806000905060608590506060856040519080825280602002602001820160405280156107a357816020015b610790610df8565b8152602001906001900390816107885790505b50905060015493505b6000841115610d5357816040516020016107c691906113b8565b60405160208183030381529060405280519060200120600085815481106107e957fe5b906000526020600020906007020160040160405160200161080a91906113cf565b604051602081830303815290604052805190602001201415610d45576000848154811061083357fe5b90600052602060002090600702016040518060e0016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108e55780601f106108ba576101008083540402835291602001916108e5565b820191906000526020600020905b8154815290600101906020018083116108c857829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109875780601f1061095c57610100808354040283529160200191610987565b820191906000526020600020905b81548152906001019060200180831161096a57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a295780601f106109fe57610100808354040283529160200191610a29565b820191906000526020600020905b815481529060010190602001808311610a0c57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610acb5780601f10610aa057610100808354040283529160200191610acb565b820191906000526020600020905b815481529060010190602001808311610aae57829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b6d5780601f10610b4257610100808354040283529160200191610b6d565b820191906000526020600020905b815481529060010190602001808311610b5057829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c0f5780601f10610be457610100808354040283529160200191610c0f565b820191906000526020600020905b815481529060010190602001808311610bf257829003601f168201915b505050505081526020016006820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681525050818481518110610c7a57fe5b602002602001018190525060008481548110610c9257fe5b90600052602060002090600702016005018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d375780601f10610d0c57610100808354040283529160200191610d37565b820191906000526020600020905b815481529060010190602001808311610d1a57829003601f168201915b505050505091506001830192505b8380600190039450506107ac565b8094505050505092915050565b60015481565b60018060008282540192505081905550565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610db957805160ff1916838001178555610de7565b82800160010185558215610de7579182015b82811115610de6578251825591602001919060010190610dcb565b5b509050610df49190610e4b565b5090565b6040518060e00160405280606081526020016060815260200160608152602001606081526020016060815260200160608152602001600073ffffffffffffffffffffffffffffffffffffffff1681525090565b610e6d91905b80821115610e69576000816000905550600101610e51565b5090565b90565b600081359050610e7f8161165c565b92915050565b600081359050610e9481611673565b92915050565b600082601f830112610eab57600080fd5b8135610ebe610eb982611504565b6114d7565b91508082526020830160208301858383011115610eda57600080fd5b610ee5838284611609565b50505092915050565b600081359050610efd8161168a565b92915050565b600060208284031215610f1557600080fd5b600082013567ffffffffffffffff811115610f2f57600080fd5b610f3b84828501610e9a565b91505092915050565b600080600080600080600080610100898b031215610f6157600080fd5b600089013567ffffffffffffffff811115610f7b57600080fd5b610f878b828c01610e9a565b985050602089013567ffffffffffffffff811115610fa457600080fd5b610fb08b828c01610e9a565b975050604089013567ffffffffffffffff811115610fcd57600080fd5b610fd98b828c01610e9a565b965050606089013567ffffffffffffffff811115610ff657600080fd5b6110028b828c01610e9a565b955050608089013567ffffffffffffffff81111561101f57600080fd5b61102b8b828c01610e9a565b94505060a089013567ffffffffffffffff81111561104857600080fd5b6110548b828c01610e9a565b93505060c06110658b828c01610e70565b92505060e06110768b828c01610e85565b9150509295985092959890939650565b6000806040838503121561109957600080fd5b600083013567ffffffffffffffff8111156110b357600080fd5b6110bf85828601610e9a565b92505060206110d085828601610eee565b9150509250929050565b6000602082840312156110ec57600080fd5b60006110fa84828501610eee565b91505092915050565b600061110f83836112ea565b905092915050565b611120816115c1565b82525050565b61112f816115c1565b82525050565b600061114082611555565b61114a8185611583565b93508360208202850161115c85611530565b8060005b8581101561119857848403895281516111798582611103565b945061118483611576565b925060208a01995050600181019050611160565b50829750879550505050505092915050565b6111b3816115d3565b82525050565b60006111c48261156b565b6111ce81856115b6565b93506111de818560208601611618565b80840191505092915050565b60006111f582611560565b6111ff8185611594565b935061120f818560208601611618565b6112188161164b565b840191505092915050565b600061122e82611560565b61123881856115a5565b9350611248818560208601611618565b6112518161164b565b840191505092915050565b600081546001811660008114611279576001811461129e576112e2565b607f600283041661128a81876115b6565b955060ff19831686528086019350506112e2565b600282046112ac81876115b6565b95506112b785611540565b60005b828110156112d9578154818901526001820191506020810190506112ba565b82880195505050505b505092915050565b600060e083016000830151848203600086015261130782826111ea565b9150506020830151848203602086015261132182826111ea565b9150506040830151848203604086015261133b82826111ea565b9150506060830151848203606086015261135582826111ea565b9150506080830151848203608086015261136f82826111ea565b91505060a083015184820360a086015261138982826111ea565b91505060c083015161139e60c0860182611117565b508091505092915050565b6113b2816115ff565b82525050565b60006113c482846111b9565b915081905092915050565b60006113db828461125c565b915081905092915050565b600060208201905081810360008301526114008184611135565b905092915050565b600060208201905061141d60008301846111aa565b92915050565b600060e082019050818103600083015261143d818a611223565b905081810360208301526114518189611223565b905081810360408301526114658188611223565b905081810360608301526114798187611223565b9050818103608083015261148d8186611223565b905081810360a08301526114a18185611223565b90506114b060c0830184611126565b98975050505050505050565b60006020820190506114d160008301846113a9565b92915050565b6000604051905081810181811067ffffffffffffffff821117156114fa57600080fd5b8060405250919050565b600067ffffffffffffffff82111561151b57600080fd5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b60008190508160005260206000209050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600081905092915050565b60006115cc826115df565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b8381101561163657808201518184015260208101905061161b565b83811115611645576000848401525b50505050565b6000601f19601f8301169050919050565b611665816115c1565b811461167057600080fd5b50565b61167c816115d3565b811461168757600080fd5b50565b611693816115ff565b811461169e57600080fd5b5056fea264697066735822122083ba59496e3aaadbc0640605818c1e7f8a524ecf6f6e8ff3809806bcd9104fc464736f6c63430006040033'

Fila = web3.eth.contract(abi=abi, bytecode=bytecode)

tx_hash = "0x8b1f72bafa232396f6378906c44cf33688b9bcfd33b0121258de3c4f7e35dc1c"

tx_receipt = web3.eth.getTransactionReceipt(tx_hash)

contratoInsercao = web3.eth.contract(
    address=tx_receipt.contractAddress,
    abi=abi
)

x = -1
while(x!=0):
    print("Menu")
    print("0 - Sair")
    print("1 - Adicionar Informações")
    print("2 - Verificar Informações")
    print("3 - Rastrear Produto")
    x  = int(input())
    if (x == 0):
        break
    elif (x == 1):
        print("--- Adicionar Informações ---")
        addr = input("Endereço Sensor: ")
        info = input("Hash das informações: ")
        dia = input("Data: ")
        hora = input("Hora: ")
        local = input("Local: ")
        codigo = input("Código do Produto: ")
        codAnterior = input("Código Anterior do Produto: ")

        try:
            valid_address = web3.toChecksumAddress(addr)
            tx_hash = contratoInicializacao.functions.verificarUsuario(valid_address).call()
            print(tx_hash)
            password = input("Account Password: ")
            if(tx_hash):
                web3.geth.personal.unlockAccount(web3.eth.accounts[0], password)
                tx_hash = contratoInsercao.functions.addInfo(info, dia, hora, local, codigo, codAnterior, valid_address, True).transact()

                tx_receipt = web3.eth.waitForTransactionReceipt(tx_hash)
            else:
                print("Usuário não cadastrado.")
        except:
            print("Endereço de Sensor Inválido")
        
    elif (x == 2):
        print("--- Verificar Informações ---")
        info = input("Código do Produto: ")
        print(contratoInsercao.functions.verificarInfo(info).call())
    elif(x == 3):
        print("--- Rastreio de Produto ---")
        code = input("Código do Produto: ")
        quantidadeUsuarios = contratoInicializacao.functions.quantidadeUsuarios().call()
        print(quantidadeUsuarios)
        tx_hash = contratoInsercao.functions.rastreioProd(code, quantidadeUsuarios).call()
        print(tx_hash)
         
        